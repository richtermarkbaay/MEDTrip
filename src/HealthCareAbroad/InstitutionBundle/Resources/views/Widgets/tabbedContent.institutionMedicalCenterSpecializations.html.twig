{% embed 'InstitutionBundle:Widgets:tabbedContent.base.html.twig' %}
    {% block tabbedContent %}
    <section class="section action-info hca-main-profile">
        <div class="hca-display">
           <button class="btn btn-misc pull-right btn-edit" onclick="toggle(this)">x</button>
            {% set _commonDeleteCsrfTokenWidget = form_widget(commonDeleteForm._token) %}
           <div class="show-specializations" >
                    <form name="specializationsForm" action="{{ path('institution_signup_setup_specializations', { imcId: institutionMedicalCenter.id }) }}" method="post">
                        <section class="section specializations">
                            <div class="accordion tooltip-wrap" id="accordion">
                                {% for institutionSpecialization in specializations %}
                                <div class="accordion-group">
                                    <div class="accordion-heading">
                                        <a class="accordion-toggle" data-toggle="collapse" data-target="#collapse{{ institutionSpecialization.id }}">
                                            <i class="icon-plus-sign pull-right"></i><h4>{{ institutionSpecialization.specialization.name }}</h4>
                                        </a>
                                    </div>
                                     {% include 'InstitutionBundle:MedicalCenter:list.treatments.html.twig'  %}
                                    <div id="collapse{{ institutionSpecialization.id }}" data-specialization="{{ institutionSpecialization.specialization.id }}" class=" collapse">
                                        <div class="accordion-inner">
                                            <div id="{{ 'panel' ~ institutionSpecialization.specialization.id }}" data-loaded="0" class="row-fluid services-listing">
                                                <center><img src="/images/institution/spinner_large.gif" /></center>
                                               
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </section>
            
                        <section class="section footer">
                            <div class="row-fluid terms">
                                <div class="span12">
                                    <button type="submit" class="btn pull-right btn-primary btn-large">
                                        Save and Continue
                                    </button>
                                </div>
                            </div>
                        </section>
                    </form>
            </div>
        </div>
    </section>
    {% endblock %}
{% endembed %}

{% block inlineJavascriptCode %}

<script type="text/javascript">
$(document).on('show hide', '#accordion', function(e) {
    var target = $(e.target);
    target.siblings('.accordion-heading').find('.accordion-toggle i').toggleClass('icon-plus-sign icon-minus-sign');

    var modifiableDiv = target.find('#panel' + target.data('specialization'));
    $('#treatments_block_'+target.data('specialization')).toggle();
    if (!modifiableDiv.data('loaded')) {

        /* TODO: ideally we should return the data not html */
        $.ajax({
            url: "{{ path('institution_ajax_loadInstitutionMedicalCenterSpecializationComponents') }}",
            type: 'GET',
            data: { 'specializationId': target.data('specialization'), 'imcId' : '{{institutionMedicalCenter.id}}' },
            dataType: 'html',
            success: function(response){
                modifiableDiv.html(response);
                modifiableDiv.data('loaded', 1);
            }
        });
    }
});

/*
TODO: are these performant? we want to avoid binding multiple event handlers but
at the same time we don't want every click event to fire and run these code.

Note: These are heavily reliant on the html markup. Changes to the structure might
break the script.
*/
$('#accordion').on('click', 'input:checkbox[name="subSpecialization"]', function(e) {
    var target = $(e.target);

    target.parent().parent().find('input:checkbox[name^="treatments"]').each(function() {
        if (target.attr('checked')) {
            $(this).attr('checked', target.attr('checked'));
        } else {
            $(this).removeAttr('checked');
        }
    });
});

$('#accordion').on('click', 'input:checkbox[name^="treatments"]', function(e) {
    var target = $(e.target);
    var subSpecializationCheckbox = target.parent().parent().parent().find('input:checkbox[name="subSpecialization"]');

    if (target.attr('checked')) {
        subSpecializationCheckbox.attr('checked', 'checked');
    } else {
        var uncheckSubSpecializationCheckbox = true;
        target.parent().parent().find('input:checkbox[name^="treatments"]').each(function() {
            if ($(this).attr('checked')) {
                uncheckSubSpecializationCheckbox = false;

                return false;/*break*/
            }
        });

        if (uncheckSubSpecializationCheckbox) {
            subSpecializationCheckbox.removeAttr('checked');
        }
    }
});

$('#submitFormLink').click(function(e) {
    //TODO: validation
    document.forms['specializationsForm'].submit();

    return false;
});

</script>

{% endblock %}
