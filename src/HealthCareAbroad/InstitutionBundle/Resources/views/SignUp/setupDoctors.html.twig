{% extends 'InstitutionBundle::registration.layout.html.twig' %}
{% set disableMainNavigation = true %}
{% set setUpProfile = true %}
                
{% block content %}

    <div class="row">
        <h1>{{ institutionMedicalCenter.name }}</h1>
    
        <div class="span8">
            <section>
                <div class="row-fluid">
                    <h2 class="pull-left">List of Doctors </h2>
                    <a id="addDoctorButton" href="#add-doctor" class="btn btn-primary btn-large pull-right" data-toggle="modal">Search Add Doctor</a>
                </div>
            </section>

            <section id="doctorsList" class="doctors-new-listing">
                {% for doctor in institutionMedicalCenter.doctors %}
                    <div class="doctor-heading medicalCenter-doctors" style="margin-bottom: 1px; min-height: 60px;padding: 10px">
                        <a href="{{ path('institution_medicalCenter_removeDoctor', {imcId: institutionMedicalCenter.id, doctorId: doctor.id}) }}" class="remove-doctor"><i class="icon-remove-sign pull-right"></i></a>
                        <a data-doctor="{{ json_encode(doctors[doctor.id]) }}" href="{{ path('institution_medicalCenter_ajaxUpdateDoctor', {imcId: institutionMedicalCenter.id, doctorId: doctor.id}) }}" class="edit-doctor-btn"><i class="icon-edit pull-right"></i></a>
                        <span><img alt="" src="{{ doctor.media ? doctor_media_src(doctor.media) : imageplaceholder.doctorDefaultImage }}" class="pull-left img-polaroid"></span>
                        <h4>Dr. {{ doctor.firstName|title }} {{ doctor.middleName ? doctor.middleName|slice(0,1)|title ~ '. ' : '' }}{{ doctor.lastName|title }} {{ doctor.suffix ? doctor.suffix : '' }}</h4>
                        {% if doctor.specializations|length %}
                            <p><i class="icon-stethoscope"></i>Specializations:<span>{{ doctor.specializations|join(', ') }}</span></p>
                        {% endif %}
                    </div>
                    <div class="doctors-listing edit-doctor-wrapper" data-doctor-id="{{ doctor.id }}" style="display:none"></div>
                {% else %}
                    <h2><small>No doctors on the list, please add your doctors now. {{ institutionMedicalCenter.doctors|length }}</small></h2>
                {% endfor %}
            </section>
    
            <section id="doneSection" {% if not institutionMedicalCenter.doctors|length %} style="display:none" {% endif %}>

                <a href="dashboard-hospital-initial.html" class="btn pull-right btn-success btn-large">
                    Done Adding Doctors
                </a>
                
            </section>
        </div>

        <aside class="span4">
            {{ render_signup_steps_by_route(app.request.attributes.get('_route'), false) | raw}}
        </aside>
    </div>

    <form method="post" id="edit-doctor-form" class="edit-doctor-form" {{ form_enctype(editForm) }} style="display:none">
        <div class="row-fluid">
            <div class="control-group span6">
                {{ form_row(editForm.lastName, { 'attr': {'class': 'span12'} }) }}
            </div>
            <div class="control-group span6">
                {{ form_row(editForm.firstName, { 'attr': {'class': 'span12'} }) }}
            </div>
        </div>
        <div class="row-fluid">
            <div class="control-group span6">
                {{ form_row(editForm.middleName, { 'attr': {'class': 'span12'} }) }}
            </div>
            <div class="control-group span6">
                {{ form_row(editForm.suffix, { 'attr': {'class': 'span12'} }) }}
            </div>
        </div>
        <div class="row-fluid">
            <div class="control-group">
                <label for="specializations">Doctor's Specializations</label>
                {{ form_widget(editForm.specializations, {attr: {class: 'span12'} }) }}
            </div>
        </div>

        <div class="row-fluid">
            <div class="control-group span6">
                <label for="Email Address">
                    Doctor's Email Address<br>
                    <small>This email will not be listed on the webpage.</small>
                </label>
                {{ form_widget(editForm.contactEmail, { 'attr': {'class': 'span12'} }) }}
            </div>
            <div class="control-group span6">
                <label for="Phone Number">
                    Doctor's Contact Number<br>
                    <small>This number will not be listed on the webpage.</small>
                </label>
                {% for _widget in editForm.contactDetails %}
                    {{ form_widget(_widget) }}
                {% endfor %}
            </div>
        </div>
        <div class="row-fluid">
            <div class="control-group span6">
                <button type="button" class="btn btn-default file-browse-btn" onclick="$(this).next().click()">Browse Profile Pic</button>
                {{ form_widget(editForm.media, { 'attr': {'class': 'span12'} }) }}
            </div>
        </div>
        
        {{ form_widget(editForm._token) }}
        
        <div class="align-right">
            <button type=submit class="btn btn-primary submit-doctor-btn">Save</button>
        </div>
    </form>

    {% include 'InstitutionBundle:SignUp/Widgets:modalForm.doctors.html.twig' %}

{% endblock %}


{% block inlineJavascriptCode %}
<script type="text/javascript">
(function($){
	$(function(){
    	
        {% if institutionMedicalCenter.doctors|length < 1 %}
            $('#add-doctor').modal('show');
        {% endif %}

        $('#add-doctor').on('show', function(){
            $('.doctors-listing').hide();
        });

        $('#add-doctor').on('hide', function(){
        	$("#main-wrap").scrollTop(0);
        });

        $('.remove-doctor').click(function(e) {
    
            if($(this).attr('disabled') == 'disabled') {
            	return false;
            }
    
            $(this).attr('disabled', 'disabled').css({opacity:.3,cursor: 'default'});
    
            doctorItem = $(this).parent();
            $.post($(this).attr('href'), function(response) {
            	$('#confirmation-message').find('p:first').html(response.message);
                if(response.status) {
                	doctorItem.fadeOut(500,function(){ doctorItem.remove(); $('#confirmation-message').show(); });
        			$('#confirmation-message').find('.alert').prop('class', 'alert alert-success');
    
                } else {
        			$('#confirmation-message').find('.alert').prop('class', 'alert alert-error');
        			$('#confirmation-message').show()
                }
    
                setTimeout(function() {$('#confirmation-message').fadeOut('slow')}, 5000); 
            });
            return false;
        });
    
        $(".edit-doctor-btn").click(function(e) {
            
            e.preventDefault();
            doctor = $.parseJSON($(this).attr('data-doctor'));

            var btnIcon = $(this).find('i');
            var editFormWrapper = $(this).parent().next();

        	if($(this).find('.icon-ok')) {
            	console.log('submitForm');
        		editFormWrapper.find('.edit-doctor-form:first').submit();
            }

            if(editFormWrapper.is(':hidden')) { 
            	editForm = $('#edit-doctor-form').clone();
            	editForm.removeAttr('id').removeAttr('style').attr('action', $(this).attr('href'));

            	editForm.find("#{{ editForm.getChild('lastName').vars.id }}").val(doctor.lastName);
            	editForm.find("#{{ editForm.getChild('firstName').vars.id }}").val(doctor.firstName);
            	editForm.find("#{{ editForm.getChild('middleName').vars.id }}").val(doctor.middleName);
            	editForm.find("#{{ editForm.getChild('suffix').vars.id }}").val(doctor.suffix);
            	editForm.find("#input-{{ editForm.getChild('suffix').vars.id }}").val(doctor.suffix);
            	editForm.find("#{{ editForm.getChild('contactEmail').vars.id }}").val(doctor.contactEmail);

            	editForm.find("#{{ editForm.getChild('contactDetails').vars.id }}_0_number").val('');
            	$.each(doctor.contactDetails, function(i){
                	number = (doctor.contactDetails[i].areaCode ? doctor.contactDetails[i].areaCode : '') + doctor.contactDetails[i].number
                	editForm.find("#{{ editForm.getChild('contactDetails').vars.id }}_"+i+"_number").val(number);
                });

            	editForm.find('.specializations-listing input[type=checkbox]').removeAttr('checked');
            	$.each(doctor.specializations, function(id, name){
                	editForm.find('.specializations-listing input[value='+id+']').attr('checked', 'checked');                	
                });

            	editFormWrapper.html(editForm);

                $('.submit-doctor-btn').click(function(){
                    console.log($(this).parents('form:first'));
                    $(this).parents('form:first').submit();
                    return false;
                });
            }

            editFormWrapper.slideToggle("slow", function(){
                if(btnIcon.hasClass('icon-edit')) {
                	btnIcon.removeClass('icon-edit').addClass('icon-ok');
                } else {
                	btnIcon.removeClass('icon-ok').addClass('icon-edit');
                }
            });

            resetDoctorForms(doctor.id);
        });
	});
})(jQuery);

    function resetDoctorForms(currentDoctorId)
    {
        $('.edit-doctor-wrapper').each(function() {
            $(this).remove('.edit-doctor-form');
            doctorId = $(this).attr('data-doctor-id');

            if(doctorId != currentDoctorId) {
                $(this).slideUp().prev().find('.icon-ok:first').removeClass('icon-ok').addClass('icon-edit');

            	$(this).find('input[id^="{{ editForm.vars.id }}_"]').attr('id', 
        		function(){
            		if($(this).attr('id').substr(-4, 4) != 'temp') {

            	        elemId = $(this).attr('id');
            	        if(elemId.substr(-6, 6) == 'suffix') {
                	        $(this).parent().find('#input-' + elemId + ', #select-' + elemId + ', #btn-' + elemId).attr('id', function(){return $(this).attr('id') + '_temp'});
                	    }

            	        newId = $(this).attr('id') + '_temp';
            	        //console.log($(this).attr('id'));
            	        return newId;
                	}
        	    });
            }
        });
    }
</script>
{% endblock %}