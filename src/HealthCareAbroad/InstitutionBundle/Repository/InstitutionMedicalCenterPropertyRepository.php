<?php

namespace HealthCareAbroad\InstitutionBundle\Repository;

use HealthCareAbroad\HelperBundle\Entity\AwardingBody;

use Doctrine\ORM\Query;
use HealthCareAbroad\HelperBundle\Classes\QueryOptionBag;
use Doctrine\ORM\Mapping\ClassMetadata;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionPropertyType;

use HealthCareAbroad\HelperBundle\Entity\GlobalAward;

use Doctrine\ORM\Query\ResultSetMapping;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionMedicalCenter;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionProperty;

use Doctrine\ORM\EntityRepository;

/**
 * InstitutionPropertyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class InstitutionMedicalCenterPropertyRepository extends EntityRepository
{   
    /**
     * Get all ancillary services by institution medical center
     * 
     * @param Mixed <InstitutionMedicalCenter, int> $institutionMedicalCenter
     * @return array OfferedService
     */
    public function getAllServicesByInstitutionMedicalCenter($institutionMedicalCenter, $hydrationMode=Query::HYDRATE_OBJECT)
    {
        if ($institutionMedicalCenter instanceof InstitutionMedicalCenter){
            $institutionMedicalCenterId = $institutionMedicalCenter->getId();
        }
        else {
            $institutionMedicalCenterId = $institutionMedicalCenter;
        }
        
        $rsm = new ResultSetMapping();
        $rsm->addEntityResult('AdminBundle:OfferedService', 'b');
        $rsm->addFieldResult('b', 'id', 'id');
        $rsm->addFieldResult('b', 'name', 'name');
        $rsm->addFieldResult('b', 'status', 'status');
        $rsm->addFieldResult('b', 'date_created', 'dateCreated');
        
        $sql = "SELECT b.* FROM institution_medical_center_properties a JOIN offered_services b ON b.id = a.value 
        WHERE a.institution_medical_center_id = :imcId
        AND a.institution_property_type_id = :propertyType
        AND b.status = 1
        ORDER BY b.name ASC";
        $query = $this->getEntityManager()->createNativeQuery($sql, $rsm)
            ->setParameter('imcId', $institutionMedicalCenterId)
            ->setParameter('propertyType', InstitutionPropertyType::ANCILLIARY_SERVICE_ID);
        
        return $query->getResult($hydrationMode);
    }
    
    /**
     * Get global awards of an institution medical center
     * 
     * @param Mixed <InstitutionMedicalCenter, int> $institutionMedicalCenter
     * @return array GlobalAward
     */
    public function getAllGlobalAwardsByInstitutionMedicalCenter($institutionMedicalCenter, $hydrationMode=Query::HYDRATE_OBJECT)
    {
        if ($institutionMedicalCenter instanceof InstitutionMedicalCenter) {
            $institutionMedicalCenterId = $institutionMedicalCenter->getId();
        }
        else {
            $institutionMedicalCenterId = $institutionMedicalCenter;
        }
        $sql = "SELECT a.value  FROM institution_medical_center_properties a ".
            "WHERE a.institution_property_type_id = :propertyType AND a.institution_medical_center_id = :imcId";
        $statement = $this->getEntityManager()
            ->getConnection()->prepare($sql);
 
        $statement->execute(array(
            'propertyType' => InstitutionPropertyType::GLOBAL_AWARD_ID,
            'imcId' => $institutionMedicalCenterId
        ));
        
        $result = array();
        if($statement->rowCount() > 0) {
            $ids = array();
            while ($row = $statement->fetch(Query::HYDRATE_ARRAY)) {
                $ids[] = $row['value'];
            }
            
            $dql = "SELECT a, b FROM HelperBundle:GlobalAward a INNER JOIN a.awardingBody as b WHERE a.id IN (?1)";
            $query = $this->getEntityManager()->createQuery($dql)
            ->setParameter(1, $ids);
             
            $result = $query->getResult($hydrationMode);
        }
   
        return $result;
    }
    
    public function getAvailableGlobalAwardsOfInstitutionMedicalCenter(InstitutionMedicalCenter $institutionMedicalCenter, QueryOptionBag $options)
    {
        $globalAwardPropertyType = $this->getEntityManager()->getRepository('InstitutionBundle:InstitutionPropertyType')->findOneBy(array('name' => InstitutionPropertyType::TYPE_GLOBAL_AWARD));
        $sql = "SELECT a.value  FROM institution_medical_center_properties a WHERE a.institution_property_type_id = :propertyType AND a.institution_medical_center_id = :institutionMedicalCenterId";
    
        $statement = $this->getEntityManager()
        ->getConnection()->prepare($sql);
    
        $statement->execute(array('propertyType' => $globalAwardPropertyType->getId(), 'institutionMedicalCenterId' => $institutionMedicalCenter->getId()));
    
        $result = array();
        $ids = array();
        if($statement->rowCount() > 0) {
            while ($row = $statement->fetch(Query::HYDRATE_ARRAY)) {
                $ids[] = $row['value'];
            }
        }
    
        $qb = $this->getEntityManager()->createQueryBuilder()
        ->select('a,b')
        ->from('HelperBundle:GlobalAward', 'a')
        ->innerJoin('a.awardingBody', 'b')
        ->where('a.status = :globalAwardActiveStatus' )
        ->setParameter('globalAwardActiveStatus',GlobalAward::STATUS_ACTIVE)
        ->orderBy('a.name', 'ASC');
    
        if ($options->has('globalAward.name')) {
            $qb->andWhere('a.name LIKE :globalAwardName')
            ->setParameter('globalAwardName', '%'.$options->get('globalAward.name').'%');
        }
    
        if ($options->has('globalAward.type')) {
            $qb->andWhere('a.type = :globalAwardType')
            ->setParameter('globalAwardType', $options->get('globalAward.type'));
        }
    
        if (\count($ids)) {
            $qb->andWhere($qb->expr()->notIn('a.id', ':globalAwardIds'))
            ->setParameter('globalAwardIds', $ids);
        }
        //echo $qb->getQuery()->getSQL(); exit;
        return $qb->getQuery()->getResult();
    }
    
    public function getPropertyValues(InstitutionPropertyType $propertyType, InstitutionMedicalCenter $medicalCenter)
    {
        $query = $this->getEntityManager()->createQuery('
                        SELECT a FROM InstitutionBundle:InstitutionMedicalCenterProperty a
                        INNER JOIN a.institutionMedicalCenter b
                        LEFT JOIN a.institutionPropertyType c
                        WHERE a.institutionMedicalCenter = :medicalCenter
                        AND a.institutionPropertyType = :propertyType ')
                        ->setParameter('medicalCenter', $medicalCenter)
                        ->setParameter('propertyType', $propertyType->getId());
        
        return $query->getResult();
        
    }
}