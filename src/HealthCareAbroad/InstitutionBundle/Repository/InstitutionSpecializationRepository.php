<?php
namespace HealthCareAbroad\InstitutionBundle\Repository;


use HealthCareAbroad\InstitutionBundle\Entity\Institution;

use Doctrine\ORM\Query\Expr\Join;

use HealthCareAbroad\TreatmentBundle\Entity\Specialization;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionMedicalCenter;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionStatus;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionMedicalCenterStatus;

use Doctrine\ORM\Query\ResultSetMapping;

use Doctrine\Common\Persistence\Mapping\ClassMetadata;

use Doctrine\ORM\Query;

use HealthCareAbroad\InstitutionBundle\Entity\InstitutionSpecialization;

use Proxies\__CG__\HealthCareAbroad\InstitutionBundle\Entity\InstitutionTreatment;

use HealthCareAbroad\TreatmentBundle\Entity\Treatment;

use Doctrine\ORM\EntityRepository;
use HealthCareAbroad\HelperBundle\Services\Helpers\QueryHelper;

/**
 * InstitutionSpecializationRepository
 *
 * This class was generated by Harold Modesto. Add your own custom
 * repository methods below.
 */
class InstitutionSpecializationRepository extends EntityRepository
{
    public function getResultByFilters(array $filters=array(), $hydrationMode=Query::HYDRATE_ARRAY)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('inst_sp, inst, imc, sp')
            ->from('InstitutionBundle:InstitutionSpecialization', 'inst_sp')
            ->innerJoin('inst_sp.institutionMedicalCenter', 'imc')
            ->innerJoin('imc.institution', 'inst')
            ->innerJoin('inst_sp.specialization', 'sp')
            ->where('1=1');
        
        $knownFilters = array(
        	'specialization' => $qb->expr()->eq('inst_sp.specialization', ':specialization') 
        );
        
        $qb = QueryHelper::applyQueryBuilderFilters($qb, $knownFilters, $filters);
        
        $qb->orderBy('inst.name', 'ASC');
        
        return $qb->getQuery()->getResult($hydrationMode);
    }
    
    public function getCountByMedicalCenterId($medicalCenterId) {
        $qb = $this->_em->createQueryBuilder();

        $qb->select('count(a)')
        ->from('InstitutionBundle:InstitutionMedicalCenter', 'a')
        ->andWhere('a.medicalCenter = :medicalCenterId')
        ->setParameter('medicalCenterId', $medicalCenterId);

        $count = (int)$qb->getQuery()->getSingleScalarResult();

        return $count;
    }

    public function getAvailableTreatments(InstitutionSpecialization $institutionSpecialization)
    {
        $qb = $this->_em->createQueryBuilder();

        $sql = "SELECT i.`treatment_id` as treatment_id FROM `institution_treatments` i WHERE i.`institution_specialization_id` = :institutionSpecializationId";
        $statement = $this->getEntityManager()
            ->getConnection()->prepare($sql);

        $statement->execute(array('institutionSpecializationId' => $institutionSpecialization->getId()));
        $result = array();

        $ids = array();
        while ($row = $statement->fetch(Query::HYDRATE_ARRAY)) {
            $ids[] = $row['treatment_id'];
        }
        $hasIds = $statement->rowCount() > 0;
        if ($hasIds) {
            $dql = "SELECT t, s FROM TreatmentBundle:Treatment t LEFT JOIN t.subSpecializations s WHERE ".
                " t.id NOT IN (?1) ".
                "AND t.specialization = :specializationId AND t.status = :status ";

            $query = $this->_em->createQuery($dql)
                ->setParameter(1, $ids)
                ->setParameter('specializationId', $institutionSpecialization->getSpecialization()->getId())
                ->setParameter('status', Treatment::STATUS_ACTIVE);
        }
        else {
            $dql = "SELECT t, s FROM TreatmentBundle:Treatment t LEFT JOIN t.subSpecializations s WHERE t.specialization = :specializationId AND t.status = :status";

            $query = $this->_em->createQuery($dql)
                ->setParameter('specializationId', $institutionSpecialization->getSpecialization()->getId())
                ->setParameter('status', Treatment::STATUS_ACTIVE);
        }

        return $query->getResult();
    }

    /**
     * TODO: This should not be here!
     * 
     * @param unknown_type $institutionId
     */
    public function getMedicalCentersList($institutionId)
    {
        $qb = $this->_em->createQueryBuilder()
        ->select('b.id, b.name')
        ->from('InstitutionBundle:InstitutionMedicalCenter', 'a')
        ->leftJoin('a.medicalCenter', 'b')
        ->add('where','a.institution = :institution')
        ->setParameter('institution', $institutionId)
        ->orderBy('b.name', 'ASC');

        return $qb->getQuery()->getResult();
    }

    /**
     * Get active institution specializations of an institution medical center/ clinic
     * 
     * @param Mixed <InstitutionMedicalCenter, int> $institutionMedicalCenter
     * @return array InstitutionSpecialization
     */
    public function getActiveSpecializationsByInstitutionMedicalCenter($institutionMedicalCenter, $hydrationMode=Query::HYDRATE_OBJECT)
    {
        if ($institutionMedicalCenter instanceof InstitutionMedicalCenter) {
            $institutionMedicalCenterId = $institutionMedicalCenter->getId();
        }
        else {
            $institutionMedicalCenterId = $institutionMedicalCenter;
        }
        
        $qb = $this->getEntityManager()->createQueryBuilder();
        
        $qb->select('a, b, sp_lg, c, sub')
        ->from('InstitutionBundle:InstitutionSpecialization', 'a')
        ->leftJoin('a.specialization', 'b')
        ->leftJoin('b.media', 'sp_lg')
        ->leftJoin('a.treatments', 'c')
        ->leftJoin('c.subSpecializations', 'sub')
        ->where('a.institutionMedicalCenter = :institutionMedicalCenter')
        ->andWhere('a.status = :status')
        ->setParameter('institutionMedicalCenter', $institutionMedicalCenter)
        ->setParameter('status', InstitutionSpecialization::STATUS_ACTIVE)
        ->orderBy('b.name','ASC');
        
        $result = $qb->getQuery()->getResult($hydrationMode);
        
        return $result;
    }

    public function getTreatmentCountByTreatmentId($treatmentId) {
        $qry = "SELECT count(*) FROM institution_treatments WHERE treatment_id = :treatmentId";
        $param = array('treatmentId' => $treatmentId);
        $count = $this->_em->getConnection()->executeQuery($qry, $param)->fetchColumn(0);

        return $count;
    }
    
    public function deleteBySpecializationIdAndTreatmentIds($institutionSpecializationId, $deleteTreatmentIds)
    {
        $conn = $this->_em->getConnection();

        if(is_array($deleteTreatmentIds)) {
            $deleteTreatmentIds = implode(',', $deleteTreatmentIds);
        }

        $deleteQry = "DELETE FROM institution_treatments " .
                        "WHERE institution_specialization_id = :institutionSpecializationId " .
                        "AND treatment_id IN ($deleteTreatmentIds)";

        $deleteParams = array('institutionSpecializationId' => $institutionSpecializationId);
        
        $result = $conn->executeQuery($deleteQry, $deleteParams);
        
        return $result;
    }

    /**
     * @deprecated use getActiveSpecializationsByInstitution
     * @param unknown_type $institution
     */
    public function getActiveSpecializations($institution)
    {
        return $this->getActiveSpecializationsByInstitution($institution);
    }
    
    public function getAllActiveSpecializations()
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('a, b, c, d')
           ->from('InstitutionBundle:InstitutionSpecialization', 'a')
           ->leftJoin('a.treatments', 'c')
           ->leftJoin('a.specialization', 'b')
           ->leftJoin('c.subSpecializations', 'd')
           ->where('a.status = :institutionSpecializationStatus')
           ->setParameter('institutionSpecializationStatus', InstitutionSpecialization::STATUS_ACTIVE)
           ->groupBy('b')->orderBy('b.name', 'ASC');

        return $qb->getQuery()->getResult();
    }
    
    /**
     * Get all active institution specializations of an Institution
     * 
     * @param mixed Institution|int $institution
     * @return multitype:
     */
    public function getActiveSpecializationsByInstitution($institution, $hydrationMode=Query::HYDRATE_OBJECT)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('b, d, m')
        ->from('InstitutionBundle:InstitutionSpecialization', 'b')
        ->leftJoin('b.institutionMedicalCenter', 'c')
        ->leftJoin('b.specialization', 'd')
        ->leftJoin('d.media', 'm')
        ->where('c.institution = :institution')
        ->setParameter('institution', $institution)
        ->groupBy('b.specialization')
        ->orderBy('d.name');
        
        return $qb->getQuery()->getResult($hydrationMode);
    }


//    TODO - Current data structure cannot support this function already!
//     public function getMedicalCentersByTreatment(Treatment $procedureType, MedicalProcedure $procedure = null)
//     {
//         $qb = $this->_em->createQueryBuilder()
//         ->select('a')
//         ->from('InstitutionBundle:InstitutionMedicalCenter', 'a')
//         ->leftJoin('a.medicalCenter', 'b')
//         ->leftJoin('b.treatments', 'c');

//         if ($procedure) {
//             $qb->leftJoin('c.treatmentProcedures', 'd')
//             ->where('d = :procedure')
//             ->setParameter('procedure', $procedure);
//         }
//         else {
//             $qb->where('c = :procedureType')
//             ->setParameter('procedureType', $procedureType);
//         }

//         $qb->orderBy('b.name', 'ASC');

//         return $qb->getQuery()->getResult();
//     }


//    TODO - Current data structure cannot support this function already!
//     public function getMedicalCentersByCountry(Country $country)
//     {
//         $qb = $this->_em->createQueryBuilder()
//         ->select('a')
//         ->from('InstitutionBundle:InstitutionMedicalCenter', 'a')
//         ->leftJoin('a.institution', 'b')
//         ->leftJoin('a.medicalCenter', 'c')
//         ->where('b.country = :countryId')
//         ->andWhere('a.status = :status')
//         ->setParameter('countryId', $country->getId())
//         ->setParameter('status', InstitutionMedicalCenterGroupStatus::APPROVED)
//         ->orderBy('c.name', 'ASC');

//         return $qb->getQuery()->getResult();
//     }

//    TODO - Current data structure cannot support this function already!
//     public function getMedicalCentersByCity(City $country)
//     {
//         $qb = $this->_em->createQueryBuilder()
//         ->select('a')
//         ->from('InstitutionBundle:InstitutionMedicalCenter', 'a')
//         ->leftJoin('a.institution', 'b')
//         ->leftJoin('a.medicalCenter', 'c')
//         ->where('b.country = :countryId')
//         ->andWhere('a.status = :status')
//         ->setParameter('countryId', $country->getId())
//         ->setParameter('status', InstitutionMedicalCenterGroupStatus::APPROVED)
//         ->orderBy('c.name', 'ASC');

//         return $qb->getQuery()->getResult();
//     }

    public function getSpecializationTopDestinations($specialization, $numOfDestinations = 5)
    {
        $connection = $this->getEntityManager()->getConnection();

        if (is_object($specialization)) {
            $specialization = $specialization->getId();
        }

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS country_slug, COUNT(DISTINCT c.id) AS count
            FROM institutions a
            LEFT JOIN countries b ON a.country_id = b.id
            INNER JOIN institution_medical_centers c ON a.id = c.institution_id
            LEFT JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            LEFT JOIN specializations e ON d.specialization_id = e.id
            WHERE e.id = :specialization
            AND a.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations
       ');
        $stmt->bindValue('specialization', $specialization, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->execute();
        $topCountries = $stmt->fetchAll();

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS city_slug, COUNT(DISTINCT c.id) AS count, z.slug AS country_slug
            FROM institutions a
            LEFT JOIN cities b ON a.city_id = b.id
            INNER JOIN institution_medical_centers c ON a.id = c.institution_id
            INNER JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            LEFT JOIN specializations e ON d.specialization_id = e.id
            LEFT JOIN countries z ON b.country_id = z.id
            WHERE e.id = :specialization
            AND a.city_id IS NOT NULL
            AND a.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations
       ');

        $stmt->bindValue('specialization', $specialization, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->execute();

        $topCities = $stmt->fetchAll();

        return array($topCountries, $topCities);
    }

    public function getSubSpecializationTopDestinations($subSpecialization, $numOfDestinations = 5)
    {
        $connection = $this->getEntityManager()->getConnection();

        if (is_object($subSpecialization)) {
            $subSpecialization = $subSpecialization->getId();
        }

        $sql = "
            SELECT b.id, b.name AS name, b.slug AS country_slug, COUNT(DISTINCT c.id) AS count
            FROM institutions a
            LEFT JOIN countries b ON a.country_id = b.id
            LEFT JOIN institution_medical_centers c ON a.id = c.institution_id
            LEFT JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            LEFT JOIN `institution_treatments` e on d.`id` = e.`institution_specialization_id`
            INNER JOIN `treatments` f ON e.`treatment_id` = f.`id`
            INNER JOIN `treatment_sub_specializations` g ON f.`id` = g.`treatment_id`
            WHERE g.sub_specialization_id = :subSpecialization
            AND a.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations";
        $stmt = $connection->prepare($sql);

        $stmt->bindValue('subSpecialization', $subSpecialization, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->execute();
        $topCountries = $stmt->fetchAll();

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS city_slug, COUNT(DISTINCT c.id) AS count, z.slug AS country_slug
            FROM institutions a
            LEFT JOIN cities b ON a.city_id = b.id
            LEFT JOIN institution_medical_centers c ON a.id = c.institution_id
            LEFT JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            LEFT JOIN `institution_treatments` e on d.`id` = e.`institution_specialization_id`
            INNER JOIN `treatments` f ON e.`treatment_id` = f.`id`
            INNER JOIN `treatment_sub_specializations` g ON f.`id` = g.`treatment_id`
            LEFT JOIN countries z ON b.country_id = z.id
            WHERE g.sub_specialization_id = :subSpecialization
            AND a.status = :institutionStatus
            AND a.city_id IS NOT NULL
            AND c.status = :imcStatus
            GROUP BY c.id, b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations
       ');


        $stmt->bindValue('subSpecialization', $subSpecialization, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->execute();

        $topCities = $stmt->fetchAll();

        return array($topCountries, $topCities);
    }

    public function getTreatmentTopDestinations($treatment, $numOfDestinations = 5)
    {
        $connection = $this->getEntityManager()->getConnection();

        if (is_object($treatment)) {
            $treatment = $treatment->getId();
        }

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS country_slug, COUNT(DISTINCT c.id) AS count
            FROM institutions a
            LEFT JOIN countries b ON a.country_id = b.id
            INNER JOIN institution_medical_centers c ON a.id = c.institution_id
            INNER JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            INNER JOIN institution_treatments e ON d.id = e.institution_specialization_id
            LEFT JOIN treatments f ON e.treatment_id = f.id
            WHERE f.id = :treatment
            AND a.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations
       ');
        $stmt->bindValue('treatment', $treatment, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->execute();
        $topCountries = $stmt->fetchAll();

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS city_slug, COUNT(DISTINCT c.id) AS count, z.slug AS country_slug
            FROM institutions a
            LEFT JOIN cities b ON a.city_id = b.id
            INNER JOIN institution_medical_centers c ON a.id = c.institution_id
            INNER JOIN institution_specializations d ON c.id = d.institution_medical_center_id
            INNER JOIN institution_treatments e ON d.id = e.institution_specialization_id
            LEFT JOIN treatments f ON e.treatment_id = f.id
            LEFT JOIN countries z ON b.country_id = z.id
            WHERE f.id = :treatment
            AND a.status = :institutionStatus
            AND a.city_id IS NOT NULL
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :numOfDestinations
       ');
        $stmt->bindValue('treatment', $treatment, \PDO::PARAM_INT);
        $stmt->bindValue('numOfDestinations', $numOfDestinations, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->execute();

        $topCities = $stmt->fetchAll();

        return array($topCountries, $topCities);
    }

    /**
     * Get the top specializations and treatments for specified country
     *
     * @param unknown $country
     * @param number $max
     * @return multitype:unknown
     */
    public function getCountryTopTreatments($country, $max = 5)
    {
        $connection = $this->getEntityManager()->getConnection();

        if (is_object($country)) {
            $country = $country->getId();
        }

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS specialization_slug, COUNT(DISTINCT d.country_id) AS count
            FROM institution_specializations a
            LEFT JOIN specializations b ON a.specialization_id = b.id
            INNER JOIN institution_medical_centers c ON a.institution_medical_center_id = c.id
            LEFT JOIN institutions AS d ON c.institution_id = d.id
            WHERE d.country_id = :country
            AND d.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :max
       ');
        $stmt->bindValue('country', $country, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->bindValue('max', $max, \PDO::PARAM_INT);
        $stmt->execute();
        $topSpecializations = $stmt->fetchAll();

        $stmt = $connection->prepare('
            SELECT c.id, c.name AS name, c.slug AS treatment_slug, COUNT(DISTINCT e.country_id) AS count, z.slug AS specialization_slug
            FROM institution_specializations a
            INNER JOIN institution_treatments b ON a.id = b.institution_specialization_id
            LEFT JOIN treatments c ON b.treatment_id = c.id
            INNER JOIN institution_medical_centers d ON a.institution_medical_center_id = d.id
            LEFT JOIN institutions AS e ON d.institution_id = e.id
            LEFT JOIN specializations AS z ON a.specialization_id = z.id
            WHERE e.country_id = :country
            AND c.id IS NOT NULL
            AND e.status = :institutionStatus
            AND d.status = :imcStatus
            GROUP BY c.id
            ORDER BY count DESC
            LIMIT :max
       ');
        $stmt->bindValue('country', $country, \PDO::PARAM_INT);
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->bindValue('max', $max, \PDO::PARAM_INT);
        $stmt->execute();

        $topTreatments = $stmt->fetchAll();

        return array($topSpecializations, $topTreatments);
    }

    /**
     * Get the top specializations and treatments for specified city
     *
     * @param unknown $country
     * @param number $max
     * @return multitype:unknown
     */
    public function getCityTopTreatments($city, $max = 5)
    {
        $connection = $this->getEntityManager()->getConnection();

        if (is_object($city)) {
            $city = $city->getId();
        }

        $stmt = $connection->prepare('
            SELECT b.id, b.name AS name, b.slug AS specialization_slug, COUNT(DISTINCT d.city_id) AS count
            FROM institution_specializations a
            LEFT JOIN specializations b ON a.specialization_id = b.id
            INNER JOIN institution_medical_centers c ON a.institution_medical_center_id = c.id
            LEFT JOIN institutions AS d ON c.institution_id = d.id
            WHERE d.city_id = :city
            AND d.status = :institutionStatus
            AND c.status = :imcStatus
            GROUP BY b.id
            ORDER BY count DESC
            LIMIT :max
       ');
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->bindValue('city', $city, \PDO::PARAM_INT);
        $stmt->bindValue('max', $max, \PDO::PARAM_INT);
        $stmt->execute();
        $topSpecializations = $stmt->fetchAll();

        $stmt = $connection->prepare('
            SELECT c.id, c.name AS name, c.slug AS treatment_slug, COUNT(DISTINCT e.city_id) AS count, z.slug AS specialization_slug
            FROM institution_specializations a
            INNER JOIN institution_treatments b ON a.id = b.institution_specialization_id
            LEFT JOIN treatments c ON b.treatment_id = c.id
            INNER JOIN institution_medical_centers d ON a.institution_medical_center_id = d.id
            LEFT JOIN institutions AS e ON d.institution_id = e.id
            LEFT JOIN specializations AS z ON a.specialization_id = z.id
            WHERE e.city_id = :city
            AND c.id IS NOT NULL
            AND e.status = :institutionStatus
            AND d.status = :imcStatus
            GROUP BY c.id
            ORDER BY count DESC
            LIMIT :max
       ');
        $stmt->bindValue('institutionStatus', InstitutionStatus::getBitValueForActiveAndApprovedStatus(), \PDO::PARAM_INT);
        $stmt->bindValue('imcStatus', InstitutionMedicalCenterStatus::APPROVED, \PDO::PARAM_INT);
        $stmt->bindValue('city', $city, \PDO::PARAM_INT);
        $stmt->bindValue('max', $max, \PDO::PARAM_INT);
        $stmt->execute();

        $topTreatments = $stmt->fetchAll();

        return array($topSpecializations, $topTreatments);
    }
}