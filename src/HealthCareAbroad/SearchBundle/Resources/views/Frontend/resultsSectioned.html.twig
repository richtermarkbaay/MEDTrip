{% extends 'FrontendBundle::layout.html.twig' %}

{% block content %}
    <div class="search-results-wrapper span8">
        <div class="content-profile-widget-wrapper">
            <h3 class="heading">
                {% if searchResults.getTotalResults %} We have found the following matches: {% else %} No results found. {% endif %}
            </h3>

            {#% if searchResults.isPaginable %#}
                {#
                <h3 class="heading">Refine your results.</h3>
                #}
                {#% include 'SearchBundle:Frontend/Widgets:narrowsearch.html.twig' %#}
            {#% endif %#}
        </div>

        {% if relatedTreatments %}
        <div class="search-matches treatments">
             {% for specialization in relatedTreatments %}
                 <ul class="match">
                     <li><h5 class="sp"><a href="{{ path('frontend_search_results_specializations', {specialization: specialization.slug}) }}">{{ specialization.name }}</a></h5></li>
                     {% for subSpecializationId, subCategory in specialization.sub_specializations %}
                     <li>
                         <ul class="match">
                             {% if subSpecializationId %}
                                 <li><h5><a href="{{ path('frontend_search_results_subSpecializations', {specialization: specialization.slug, subSpecialization: subCategory.subSpecializationSlug }) }}">{{ subCategory.subSpecializationName }}</a></h5></li>
                             {% else %}
                                 {% if specialization.sub_specializations | length > 1 %}
                                     <li><h5><a href="#">Other Treatments</a></h5></li>
                                 {% endif %}
                             {% endif %}

                             {% for treatment in subCategory.treatments %}
                                <li class="tr"><a href="{{ path('frontend_search_results_treatments', {specialization: specialization.slug, treatment: treatment.treatmentSlug }) }}">{{ treatment.treatmentName }}</a></li>
                            {% endfor %}
                        </ul>
                     </li>
                     {% endfor %}
                 </ul>
             {% endfor %}
        </div>
        {% endif %}

        {% for searchResultVo in searchResults %}
            {# BC for old search results whose result item is a medical center #}
            {% set center = searchResultVo.institutionMedicalCenter is defined ? searchResultVo.institutionMedicalCenter : searchResultVo %}

            {# quick fix to show only institution link when type of institution is single center #}
            {# TODO: move code elsewhere; template is getting cluttered #}
            {% if center.institution.type is constant('HealthCareAbroad\\InstitutionBundle\\Entity\\InstitutionTypes::SINGLE_CENTER') %}
                {% set url = get_institution_frontend_url(center.institution) %}
                {% set name = center.institution.name %}
                {% set hideSubLink = true %}
            {% else %}
                {% set url = get_institution_medical_center_frontend_url(center) %}
                {% set name = center.name %}
                {% set hideSubLink = false %}
            {% endif %}

            {% include 'SearchBundle:Frontend/Widgets:base.resultItem.html.twig' with {
                   'statisticsDataObject': searchResultVo.institutionMedicalCenter,
                   'searchResultItem' : {
                          url: url,
                          name: name,
                          hideSubLink: hideSubLink,
                          institutionUrl: get_institution_frontend_url(center.institution),
                          logo: render_institution_medical_center_logo(center, {attr: {class: 'small', alt: 'clinic logo'}}),
                          featuredMedia: center.institution.featuredMedia,
                          institutionName: center.institution.name,
                          description: center.descriptionHighlight|length ? center.descriptionHighlight : (center.description|length > 300 ? center.description|slice(0, 300) ~ '...' : center.description),
                          mainAddress: medical_center_complete_address_to_string(center, ['city', 'state', 'country']),
                          streetAddress: medical_center_complete_address_to_string(center, ['address', 'zipCode']),
                          links: get_center_links(center, url),
                          payingStatus: center.payingClient
                   }
               }
           %}

        {% endfor %}

        {% if searchResults.isPaginable %}
            {{ paginate(searchResults, routeName, paginationParameters, 'PagerBundle:Pager:paginate_frontend_search.html.twig') }}
        {% endif %}

    </div><!--End of main_content-->
    <aside class="aside-wrapper span4">
        {{ render_search_results_featured_posts() }}
        {{ render_search_results_image_ad() }}
    </aside>
<!--End of content-->
{% endblock %}

{% block inlineJavascriptCode %}
<script type="text/javascript">
    $(window).ready(function() {
        $(".icon-globe, .icon-envelope, .icon-phone, .icon-facebook, .icon-twitter, .icon-google-plus").tooltip();
    });
</script>
{% endblock%}