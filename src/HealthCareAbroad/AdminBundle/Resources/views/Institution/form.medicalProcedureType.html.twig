{% extends 'AdminBundle::layout.html.twig' %}
{% set selectedTab = 'institutions'%}
{% block title %}{{ parent() }} {{ newProcedureType ? "Add" : "Edit"}} Procedure Type {% endblock %} 
{% form_theme form '::form.admin.html.twig' %}

{% block content %}
<!-- start content -->
<div id="content">
    <!--  start page-heading -->
    <div id="page-heading">
    	<h1>
    	    {% if newProcedureType %} 
    	        Creat procedure type
	        {% else %}
	            Edit procedure type {# institutionMedicalProcedureType.medicalProcedureType.name #}
	         {% endif %}       
        </h1>
    </div>
    <!-- end page-heading -->
    
    {% embed '::contentWrapper.admin.html.twig' %}
        
        {% block wrappedContent %}
            <table style="width:100%;">
                <tr>
                    <td style="vertical-align: top; ">
            			<!--  start table-content  -->
            			<div id="table-content">
            			
            			    {% include '::notice.admin.html.twig' %}

            				{% set contents = [
									{
										'isVisible' : newProcedureType ? false : true,
										'title': 'Add medical procedure', 
										'description': 'Add medical procedure to this procedure type',
										'class' : 'add-procedure add-icon',
										'href': path('admin_institution_addMedicalProcedure', {id:id, institution_medical_procedure_type_id: institutionMedicalProcedureType.id}), 
										'links': [
											{
												'title': 'Add a medical procedure',
												'class' : 'add-procedure',
												'href': path('admin_institution_addMedicalProcedure', {id:id, institution_medical_procedure_type_id: institutionMedicalProcedureType.id})
											}
										]
									},
									{
										'title': 'Manage Procedure Types', 
										'description': 'Go back to procedure type management page',
										'href': path('admin_institution_manageProcedureTypes', {id:id}), 
										'links': [
											{'title' : 'Add another procedure type','href': path('admin_institution_addProcedureType', {id:id}), 'isVisible' : not newProcedureType},
											{'title': 'Back to procedure type management', 'href': path('admin_institution_manageProcedureTypes', {id:id})}
										]
									}
								]
            				%}

							{% include '::relatedTasks.base.admin.html.twig' with {contents: contents} %}
							{% set savePath = newProcedureType ? path('admin_institution_createProcedureType',{id:id}) : path('admin_institution_updateProcedureType',{id:id, institution_medical_procedure_type_id:institutionMedicalProcedureType.id}) %}
            			    <form novalidate="novalidate" action="{{ savePath }}" method="POST" {{ form_enctype(form) }} class="basic-form">
                			    
                			    <!-- start id-form -->
                        		<table border="0" cellpadding="0" cellspacing="0"  id="id-form">
                        		    
                        		    {{ form_row(form.medicalCenter) }}
                                    {{ form_row(form.medicalProcedureType) }}
                                    {{ form_row(form.description) }}
                                    
                                    <tr>
                                		<th>&nbsp;</th>
                                		<td valign="top">
                                			<input type="submit" name="submit" value="" class="form-submit" />
                                			<input type="reset" value="" class="form-reset"  />
                                		</td>
                                		<td></td>
                                	</tr>
                                    
                                    {{ form_rest(form) }}
                                    
                            	</table>
                            	<!-- end id-form  -->
                        	</form>

                        	{% if(not newProcedureType) %}
                        		<br/><br/>
								<h3>Medical Procedures</h3>
							    <table border="0" width="70%" cellpadding="0" cellspacing="0" class="generic-table" id="medical-centers-list">
				    				<tr>
				    					<th class="table-header-repeat line-left minwidth-1" width="200px"><a href="#">Procedures</a></th>
				    					<th class="table-header-repeat line-left minwidth-1"><a href="#">Description</a></th>
				    					<th class="table-header-options line-left" width="50"><a href="#">Options</a></th>
				    				</tr>

									{% set procedures = institutionMedicalProcedureType.institutionMedicalProcedures %}

									{% for procedure in institutionMedicalProcedureType.institutionMedicalProcedures  %}
										{% set medicalProcedure = procedure.medicalProcedure %}
										<tr>
											<td>{{ medicalProcedure.name }}</td>
											<td>{{ procedure.description }}</td>  
											<td>
				            					<a href="#" title="Edit" class="icon-1 info-tooltip"></a>
				            					{% set class = medicalProcedure.status ? 'icon-2' : 'icon-5' %}
				            					<a href="{{ path('admin_institution_updateProcedureStatus', {
				            								id: id, 
				            								medical_procedure_id: medicalProcedure.id,
				            								institution_medical_procedure_type_id: institutionMedicalProcedureType.id
				            						}) }}"
				            						title="{{ medicalProcedure.status ? 'Delete' : 'Activate' }}" 
				            						class="update-status {{ class }} info-tooltip">
				            					</a>
											</td>
										</tr>
									{% else  %}
										<tr><td colspan="3" class="empty-list">No Medical Procedures yet!</td></tr>
									{% endfor %}
								</table>
							{% endif %}
            			</div>
            			<!--  end table-content  -->
        			</td>
        			<td style="vertical-align: top; ">
        			</td>
    			</tr>
			</table>
        {% endblock %}
        
    {% endembed %}
    
</div>

<!--  end content -->
<div class="clear">&nbsp;</div>
{% endblock %}

{% block inlineJavascriptCode %}
    <script src="{{ asset('bundles/institution/js/InstitutionMedicalProcedure.js') }}"></script>
	<script type="text/javascript">
        $(function(){

        	$("#dialog-container").dialog({
				autoOpen: false,
				height: 580,
				width: 700,
				modal: true,
				resizable: false,
				//buttons: {"Save": function() {var bValid = true;}, Cancel: function() {$( this ).dialog( "close" );} },
				close: function() {}
			});

        	$("a.add-procedure").click(function() {
				var elem = $(this);
				var addProcedureUrl = elem.attr('href');
				elem.attr('href', 'javascript:void(0)');

				$("#dialog-container").empty();
				$("#dialog-container").dialog({
					open: function() {
						$.ajax(addProcedureUrl)
							.done(function (data) {
								elem.attr('href', addProcedureUrl);
								$('#dialog-container').html(data);
							});
					},
				});
				$("#dialog-container").dialog("open");
			});
            
        	var params = {
                selectedMedicalCenter: '{{ newProcedureType ? 0 : institutionMedicalProcedureType.medicalProcedureType.medicalCenter.id }}',
                selectedMedicalProcedureType: '{{ newProcedureType ? 0 : institutionMedicalProcedureType.medicalProcedureType.id }}',
        		loadProcedureTypesUrl : "{{ path('admin_loadMedicalProcedureTypes', {id:id}) }}"
            };

    		InstitutionMedicalProcedure.init(params);
        });
	</script>	
{% endblock %}
