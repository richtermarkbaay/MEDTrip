{% extends 'AdminBundle::layout.html.twig' %}
{% set selectedTab = 'institutions'%}
{% set selectedSubTab = 'institutions_index'%}

{% block content %}
    <div id="content">

        <div id="page-heading"><h3>List of Institutions</h3></div>
        {% embed '::contentWrapper.admin.html.twig' %}
            {% block wrappedContent %}
            
            {% include '::notice.admin.html.twig' %}

            <!-- Render Filter Box -->
            {% autoescape false %} {{ listFilters is defined ? listFilters : '' }} {% endautoescape %}

            {% set sortBy = app.request.get('sortBy') %}
            {% set sortOrder = app.request.get('sortOrder') %}
            {% set default = sortBy | length ? '' : 'sort-asc' %}
            
            <div>
                <table class="table table-bordered sortable-list">
                <tr>
                    <th width="50" align="center">Paying</a></th>
                    <th width="200" id="column-name"><a href="{{ app.request.uri }}" class="{{ sortBy == 'name' ? 'sort-' ~ sortOrder : default }}">Name</a></th>
                    <th id="column-description"><a href="{{ app.request.uri }}" class="{{ sortBy == 'description' ? 'sort-' ~ sortOrder : '' }}">Description</a></th>
                     <th width="200">Insititution Type</th>
                    <th width="100">Country</th>
                  {#  <th width="100">Status</th> #}
                    <th width="130">Actions</th>
                </tr>

                {% for institution in institutions %}
                    <tr id="institution-{{institution.id}}">
                        <td style="text-align: center;padding: 0">
                            <input type="checkbox" value="1" {{ institution.payingClient ? 'checked' : '' }} class="update-paying-client" data-update-url="{{ path('admin_institution_updatePayingClient', {institutionId: institution.id}) }}">
                            <div style="display:none">updating...</div>
                        </td>
                        <td>
                            <a class="name" href="{{ path('admin_institution_view', {institutionId: institution.id}) }}" title="View {{ institution.name }}">{{ institution.name }}</a> 
                        </td>
                        <td>{{ substr(institution.description, 0, 100) }}</td>

                         {% set institutionTypeLabel = get_institution_type(institution.type)%}
                        <td>{{ institutionTypeLabel}}</td>
                        <td>{{ institution.country ? institution.country.name : '' }}</td>
                       {# <td class="status">{{ statusList[institution.status] }}</td> #}

                        <td>
                            <a href="{{ path('admin_institution_manageCenters', {institutionId:institution.id}) }}"><i class="icon-list"></i> View centers</a> 
                            <br/>
                            <a id="status-{{institution.id}}" href="{{ path('admin_institution_editStatus', {institutionId: institution.id}) }}" class="show-update-status">
                                <i class="icon-edit"></i> Edit status
                            </a>
                            <br/>
                            <a href="{{ path('admin_institution_edit_details', {institutionId:institution.id} ) }}" ><i class="icon-pencil"></i> Edit institution</a>
                        </td>
                    </tr>
                {% else  %}
                    <tr><td class="empty-list" colspan="4">No records yet!</td></tr>
                {% endfor %}
                </table>
                
     
            </div>
            
            {% endblock %}
        {% endembed %}
        
        {% if pager.isPaginable %}
           {{ paginate(pager, 'admin_institution_index', app.request.query.all) }}
        {% endif %}
    </div>

    <div id="update-status-container" title="Edit Institution Status" style="display:none">
        <p>
            <strong id="current-institution"></strong> is currently <strong id="current-status"></strong>. 
            Select an option below to update its status.
        </p>
        <form id="update-status-form" method="POST">
        <select name="status" id="selected-status">
        </select>
        <input type="submit" class="green-button" value="Confirm"/>
        </form>

    </div>
    
    <!-- Modal Institution Status -->
    	{% include 'AdminBundle:Institution/Modals:edit.institutionStatus.html.twig' 
    	     with {modalId: 'status_institution_modal_form', modalTitle: 'Edit Status'}
    	%}
    <!-- end Modal Institution Status -->
    
{% endblock %}

{% block inlineJavascriptCode %}
<script type="text/javascript" src="{{ asset('bundles/admin/js/Institution.js') }}" ></script>
<script type="text/javascript">
    $(function(){

        $("#update-status-container").dialog({autoOpen:false, height:250, width:400, modal:true, resizable:false, close:function(){}});

        $("a.show-update-status").click(function() {
        	$('div#status_institution_modal_form').modal('show');

            return false;
        });

        $('input.update-paying-client').change(function(){
            msgElem = $(this).next().html('updating...').show(); 
            var params = {
                payingClient: $(this).prop('checked') ? '1' : '0' 
            };

            $.post($(this).attr('data-update-url'), params, function(response){
            	console.log(response);
            	msgElem.html('done!');
            	setTimeout(function(){
            		msgElem.fadeOut();
                }, 1000);
            });
            //console.log();
        });

        
    });
</script>
{% endblock %}