{% extends 'AdminBundle::layout.institution.html.twig' %}

{% set centerLabel = getClassLabel('institution_medical_center').singular | title %}

{% block content %}
    <div data-spy="affix" data-offset-top="100" class="span9 navbar affix-top">

        {% embed 'HelperBundle:Widgets:section.html.twig' with {title: institutionMedicalCenter.name } %}
    
            {% block sectionContent %}
                <div id="scroll-pane" data-spy="scroll" data-target="#navbar">
                    {% include 'AdminBundle:Widgets:medicalCenter.specializationsList.html.twig'%}
                    
                    {% include 'AdminBundle:Widgets:medicalCenter.ancillaryServicesList.html.twig'%}
                    
                    {% include 'AdminBundle:Widgets:medicalCenter.businessHours.html.twig'%}
                
                    {% include 'AdminBundle:Widgets:medicalCenter.awards.html.twig'%}
        
                    <div id="mediaAccordion" class="treatmentbox">
                        <h5 style="padding: 10px; border: 1px solid #EEEEEE">
                            Media
                            <a href="{{ path('admin_media_add', {context: constant('HealthCareAbroad\\MediaBundle\\MediaContext::INSTITUTION_MEDICAL_CENTER'), id: institutionMedicalCenter.id} ) }}" class="btn btn-mini pull-right">
                                <i class="icon-plus"></i>Add
                            </a>
                        </h5>
                        <div class="boxcontent" style="border: 1px solid #EEEEEE; border-top: none;">
                            {% include 'MediaBundle:Default:mediaTableView.html.twig' with {media: institutionMedicalCenter.media} %}
                        </div>
                    </div>
                    
                    <div id="doctorsAccordion" class="treatmentbox">
                        <h5 style="padding: 10px; border: 1px solid #EEEEEE">
                            Doctors
                            <a href="{{ path('admin_institution_medicalCenter_addMedicalSpecialist', {institutionId: institution.id,imcId: institutionMedicalCenter.id } )}}" class="btn btn-mini pull-right">
                                <i class="icon-plus"></i>Add Doctors
                            </a>
                        </h5>
                        <div class="boxcontent" style="border: 1px solid #EEEEEE; border-top: none;">
                            <table class="table table-striped table-bordered bootstrap-datatable">
                        	    <thead>
                                    <tr>
                        			    <th>Medical Specialist</th>
                        				<th>Specializations</th>
                        				<th>Actions</th>
                        			</tr>
                                </thead>
                    	        <tbody>
                                 {% for doctor in institutionMedicalCenter.doctors %}
                    				<tr id="doctor_block_{{ doctor.id}}">
                    					<td>{{ doctor.lastName |title }}, {{ doctor.firstName |title }}</td>
                    					<td>
                    					{% for specialization in doctor.specializations %}
                    					    {{ specialization.name |title }} 
                    					    {% if loop.last == false %},{% endif %} 
                    				    
                    				    {% else %}
                    					    No Specializations yet
                    					{% endfor %}
                    					</td>
                    					<td>
                    						<div class="post-toolbar">
                    							<i class="icon-trash" title="Delete"></i>
                    							<a href="{{ path('admin_institution_medicalCenter_ajaxRemoveMedicalSpecialist', {institutionId: institution.id, imcId: institutionMedicalCenter.id, doctorId: doctor.id} )}}" class="removeDoctor" title="" role="button" data-toggle="modal">Delete</a>
                    						</div>
                    					</td>
                    				</tr>
                    		      {% else %}
                        		  	<tr>
                        			   <td> No Medical Specialist yet. </td>
                        			   <td></td>
                        			</tr>
                    			{% endfor %}
                    			</tbody>
                    		</table>
                        </div>
                    </div>
                </div>
            {% endblock %}
    
        {% endembed %}
    </div>
    
{% endblock %}

{% block inlineJavascriptCode %}
    <script src="{{ asset('bundles/institution/js/institutionTreatments.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/admin/js/institutionMedicalCenter.js') }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery/timepicker.js') }}"></script>
    <script src="{{ asset('js/jquery/globalize.js') }}"></script>
    <script src="{{ asset('js/jquery/jquery.ui.mask.js') }}"></script>
    <script type="text/javascript">
        $(function() {
        	$('#navbar').affix({
        		offset: $('#navbar').position()
        	});
        	$('#scroll-pane').scrollspy({target: '#navbar'});
        	$(".hour").timepicker({ seconds: false  });
            $('input.is_closed_checkbox').each(function(){
                if(this.checked) {
                    $(this).parent().parent().find('.hour').val("");
                    //var id = $(this).parent().parent().find('.hour').spinner({ disabled: true });
                }
            });
            if ($('#businessHourCheckBox').attr('checked')) {
            	$(this).parent().parent().find('.hour').val("");
    	    	var id = $(this).parent().parent().find('.hour').spinner({ disabled: true });
    	    	$('#table-businessHours').hide();
            }
            $('#dialog-container').dialog({
                position: ['center', 100],
                autoOpen: false,
                width: 750,
                modal: true,
                resizable: false,
                close: function() {}
            });

            InstitutionGlobalAwardAutocomplete
            .setLoadHtmlContentUri('{{ path("admin_institution_medicalCenter_ajaxAddGlobalAward", {"institutionId": institution.id, "imcId": institutionMedicalCenter.id}) }}') 
            .setAutocompleteOptions('award', {
                source: $.parseJSON('{{ awardsSourceJSON | raw }}'),
                target: $('input.award_selector'),
                selectedDataContainer: $('table.awards_table tbody'),
                loader: $('table.awards_table tbody tr.loader')
            })
            .setAutocompleteOptions('certificate', {
                source: $.parseJSON('{{ certificatesSourceJSON | raw }}'),
                target: $('input.certificate_selector'),
                selectedDataContainer: $('table.certificates_table tbody'),
                loader: $('table.awards_table tbody tr.loader')
            })
            .setAutocompleteOptions('affiliation', {
                source: $.parseJSON('{{ affiliationsSourceJSON | raw }}'),
                target: $('input.affiliation_selector'),
                selectedDataContainer: $('table.affiliations_table tbody'),
                loader: $('table.awards_table tbody tr.loader')
            })
            .autocomplete();
            
            $('a.add-global_award').click(function(){
                var elem = $(this);
                var _url = elem.attr('href');

                $("#dialog-container").empty();
                $('#dialog-container').dialog({
                    title: 'GlobalAwards / Certifications',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {
                                $('#dialog-container').html(data);
                            }
                        );
                    },
                });

                $('#dialog-container').dialog("open");

                     return false;
            });

            $('a.removeDoctor').click(function(){
            	var elem = $(this);
                var _url = elem.attr('href');
                
                $("#dialog-container").empty();
                $('#dialog-container').dialog({
                    title: 'Doctors',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {
                                $('#dialog-container').html(data);
                            }
                        );
                    },
                });
                

                $('#dialog-container').dialog("open");

                     return false;
            });
            
            $('a.add-offered-services').click(function(){
            	var elem = $(this);
    			var _url = elem.attr('href');

    			$("#dialog-container").empty();
    			//$('#dialog-container').dialog('option','title', (elem.hasClass("edit") ? 'Edit' : 'Add') + ' GlobalAwards');
                $('#dialog-container').dialog({
                	title: 'Add Offered Services',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {        
                            	$('#dialog-container').html(data);
                            }
                        );
                    },
                });

            	$('#dialog-container').dialog("open");

                 	return false;           
            });
            $('.medical-centers').click(function(){
                var url = $(this).find('.url').attr('href');
                var specializationElem = $(this).next().find('.specializations:first');

                if($.trim(specializationElem.html()) == '') {
                	specializationElem.html('<div class="ajax-loading">loading...</div>');
                    $.get(url, function(result) {
                    	specializationElem.html(result);
                    });
                }
            });

            $('.view-center').click(function(){
                window.location = $(this).attr('href');
                return false;
            });

            $('.edit-center-description').click(function(){
                if($(this).next().is(':visible')) {
                	$(this).find('i').attr('class', 'icon-ok');
                	$(this).find('span').html('save')
                    $(this).next().hide().siblings('.mceEditor').show();

                } else {
                    var url = $(this).attr('href');
                    var param = { description: $(this).siblings('textarea').val() };

                	$.post(url, param, function(result){}, 'json');

                	$(this).find('i').attr('class', 'icon-edit');
                	$(this).find('span').html('edit')
                    $(this).next().html(param.description).show().siblings('.mceEditor').hide();                
                }

                return false;
            });

            $('.edit-center-name').click(function(){
                if($(this).next().is(':visible')) {
                	$(this).find('i').attr('class', 'icon-ok');
                	$(this).find('span').html('save')
                    $(this).next().hide().siblings('input').show();
            
                } else {
                    var url = $(this).attr('href');
                    var param = { name: $(this).siblings('input').val() };

                	$.post(url, param, function(result){}, 'json');

                	$(this).find('i').attr('class', 'icon-edit');
                	$(this).find('span').html('edit')
                    $(this).next().html(param.name).show().siblings('input').hide();

                	$("#centersAccordion").accordion("enable");
                }

                return false;
            }).siblings('input').click(function(){
    			$('#centersAccordion').accordion("disable").removeClass('ui-state-disabled'); 
    			$(this).parent().removeClass('ui-state-disabled'); 
    		});
        });
        
        $('input.is_closed_checkbox').change(function(){
            if(this.checked) {
                $(this).parent().parent().find('.hour').val("");
                var id = $(this).parent().parent().find('.hour').spinner({ disabled: true });
            }
            else
            {
                $(this).parent().parent().find('.hour').val("8:00 AM");
                var id = $(this).parent().parent().find('.hour').spinner({ disabled: false });
            }

        });

        $('#businessHourCheckBox').click(function(){
        	
    	    if ($('#businessHourCheckBox').attr('checked')) {

    	    	$(this).parent().parent().find('.hour').val("");
    	    	var id = $(this).parent().parent().find('.hour').spinner({ disabled: true });
    	    	$('#table-businessHours').hide();
    	    	
    	    }else{
        	    $('#table-businessHours').show();
        	    $(this).parent().parent().find('.hour').val("8:00 AM");
    	    	var id = $(this).parent().parent().find('.hour').spinner({ disabled: false });
        	}
    	}) 
        
        $('#saveBusinessHours').click(function() {
            var businessHours = $('#business').serialize();
            $('div#ajax_loader').show();
            $.ajax({
                url: "{{ path('admin_institution_medicalCenter_edit', { 'institutionId':institution.id, 'imcId': institutionMedicalCenter.id }) }}",
                data: businessHours,
                type: 'post',
                success: function(){
                    $('div#ajax_loader').hide();
                }
            });

            return false;
        });

        
    </script>
{% endblock %}
