{% extends 'AdminBundle::layout.institution.html.twig' %}

{% set centerLabel = getClassLabel('institution_medical_center').singular | title %}

{% block content %}
    <div class="span9">

        {% embed 'HelperBundle:Widgets:section.html.twig' with {title: institutionMedicalCenter.name } %}
    
            {% block sectionContent %}
                <div id="scroll-pane" data-spy="scroll" data-offset-top="0" data-target="#navbar-side">
                    {% include 'AdminBundle:Widgets:medicalCenter.specializationsList.html.twig' %}
                    {% include 'AdminBundle:Widgets:medicalCenter.ancillaryServicesList.html.twig'%}
                    
                    {% include 'AdminBundle:Widgets:medicalCenter.businessHours.html.twig'%}
                
                    {% include 'AdminBundle:Widgets:medicalCenter.awards.html.twig'%}
        
                    <div id="media" class="treatmentbox">
                        <h5 style="padding: 10px; border: 1px solid #EEEEEE">
                            Media
                            <a href="{{ path('admin_media_add', {context: constant('HealthCareAbroad\\MediaBundle\\MediaContext::INSTITUTION_MEDICAL_CENTER'), id: institutionMedicalCenter.id} ) }}" class="btn btn-mini pull-right">
                                <i class="icon-plus"></i>Add
                            </a>
                        </h5>
                        <div class="boxcontent" style="border: 1px solid #EEEEEE; border-top: none;">
                            {% include 'MediaBundle:Default:mediaTableView.html.twig' with {media: institutionMedicalCenter.media} %}
                        </div>
                        
                    </div>
                    
                    {% include 'AdminBundle:Widgets:medicalCenter.medicalSpecialist.html.twig'%}
                </div>
            {% endblock %}
    
        {% endembed %}
    </div>
    
{% endblock %}

{% block inlineJavascriptCode %}
    <script src="{{ asset('bundles/helper/js/DoctorAutocomplete.js') }}"></script>
    <script src="{{ asset('bundles/admin/js/institutionTreatments.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/admin/js/institutionMedicalCenter.js') }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery/timepicker.js') }}"></script>
    <script src="{{ asset('js/jquery/globalize.js') }}"></script>
    <script src="{{ asset('js/jquery/jquery.ui.mask.js') }}"></script>
    <script type="text/javascript">
        $(function() {
        	$(".hour").timepicker({ seconds: false  });
        	var isOpen = '{{ isOpen24hrs }}';
			
        	if(isOpen) {
        		$('#businessHourCheckBox').attr("checked","checked");
        	}
        	if ($('#businessHourCheckBox').attr('checked')) {
        		$(this).parent().parent().parent().find('.is_open').val('1');
    	    	$(this).parent().parent().parent().find('.hour').spinner({ disabled: true }).val(" 8:00 AM");
    	    	$('textarea.businessHourNotes').removeAttr('disabled');
    	    	$(this).parent().parent().parent().find('.is_open_checkbox').attr({ checked: 'checked', disabled: true});
    	    	$(this).parent().parent().parent().find('.is_close_checkbox').removeAttr('checked');
    	        $(this).parent().parent().parent().find('.is_close_checkbox').attr({disabled : true});
            }
            $('input.is_close_checkbox').each(function(){
                if(this.checked) {
                    $(this).parent().parent().parent().find('.hour').val("");
                    $(this).parent().parent().parent().find('.hour').spinner({ disabled: true });
                    $(this).parent().parent().parent().next().find('.businessHourNotes').val("");
                    $(this).parent().parent().parent().next().find('.businessHourNotes').attr({ disabled: true });
                }
            });
            $('input.is_open_checkbox').each(function(){
                if(this.checked) {
                	$(this).parent().parent().parent().find('.hour').val("8:00 AM");
                    $(this).parent().parent().parent().find('.hour').spinner({ disabled: true });
                    $(this).parent().parent().parent().find('.is_open').val('1');
                    $('textarea.businessHourNotes').removeAttr('disabled');
                    $('input.is_close_checkbox').removeAttr('checked');
                    $(this).parent().parent().parent().find('.is_close_checkbox').attr({disabled : true});
                    $(this).parent().parent().parent().find('.is_open_checkbox').attr({disabled : true});
                }
            });
            
            $('#dialog-container').dialog({
                position: ['center', 100],
                autoOpen: false,
                width: 750,
                modal: true,
                resizable: false,
                close: function() {}
            });
            
            $('a.add-global_award').click(function(){
                var elem = $(this);
                var _url = elem.attr('href');

                $("#dialog-container").empty();
                $('#dialog-container').dialog({
                    title: 'GlobalAwards / Certifications',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {
                                $('#dialog-container').html(data);
                            }
                        );
                    },
                });

                $('#dialog-container').dialog("open");

                     return false;
            });

            var _nsUrl = '{{ path("admin_ajaxMedicalCenterGlobalAwardSource", {institutionId: institution.id , "imcId": institutionMedicalCenter.id}) }}';

        	InstitutionGlobalAwardAutocomplete
        	 .setLoadHtmlContentUri('{{ path("admin_institution_medicalCenter_ajaxAddGlobalAward", {"institutionId": institution.id, "imcId": institutionMedicalCenter.id}) }}') 
             .setAutocompleteOptions('award', {
             	source: _nsUrl+'?type=award',
                 target: $('input.award_selector'),
                 selectedDataContainer: $('table.awards_table tbody'),
                 loader: $('table.awards_table tbody tr.loader')
             })
             .setAutocompleteOptions('certificate', {
             	source: _nsUrl+'?type=certificate',
                 target: $('input.certificate_selector'),
                 selectedDataContainer: $('table.certificates_table tbody'),
                 loader: $('table.certificates_table tbody tr.loader')
             })
             .setAutocompleteOptions('affiliation', {
             	source: _nsUrl+'?type=affiliation',
                 target: $('input.affiliation_selector'),
                 selectedDataContainer: $('table.affiliations_table tbody'),
                 loader: $('table.affiliations_table tbody tr.loader')
             })
             .setAutocompleteOptions('accreditation', {
             	source: _nsUrl+'?type=accreditation',
                 target: $('input.accreditations_selector'),
                 selectedDataContainer: $('table.accreditation_table tbody'),
                 loader: $('table.accreditation_table tbody tr.loader')
             })
             .autocomplete();

			InstitutionSpecialistAutocomplete
	        .setLoadHtmlContentUri('{{ path("admin_institution_medicalCenter_ajaxAddMedicalSpecialist", {"imcId": institutionMedicalCenter.id, "institutionId": institution.id}) }}') 
	        .setAutocompleteOptions('specialist', {
	            source: $.parseJSON('{{ doctorsJSON | raw }}'),
	            target: $('#institutionDoctorSearch_firstName'),
	            selectedDataContainer: $('table.specialist_table tbody'),
	            loader: $('table.specialist_table tbody tr.loader'),
                field: $('#institutionDoctorSearch_firstName')
	        })
	        .autocomplete();

        	
            $('a.removeDoctor').click(function(){
            	var elem = $(this);
                var _url = elem.attr('href');
                
                $("#dialog-container").empty();
                $('#dialog-container').dialog({
                    title: 'Doctors',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {
                                $('#dialog-container').html(data);
                            }
                        );
                    },
                });
                
                $('#dialog-container').dialog("open");

                     return false;
            });
            
            $('a.add-offered-services').click(function(){
            	var elem = $(this);
    			var _url = elem.attr('href');

    			$("#dialog-container").empty();
    			//$('#dialog-container').dialog('option','title', (elem.hasClass("edit") ? 'Edit' : 'Add') + ' GlobalAwards');
                $('#dialog-container').dialog({
                	title: 'Add Offered Services',
                    open: function() {
                        $.ajax(_url)
                            .done(function (data) {        
                            	$('#dialog-container').html(data);
                            }
                        );
                    },
                });

            	$('#dialog-container').dialog("open");

                 	return false;           
            });
            $('.medical-centers').click(function(){
                var url = $(this).find('.url').attr('href');
                var specializationElem = $(this).next().find('.specializations:first');

                if($.trim(specializationElem.html()) == '') {
                	specializationElem.html('<div class="ajax-loading">loading...</div>');
                    $.get(url, function(result) {
                    	specializationElem.html(result);
                    });
                }
            });

            $('.view-center').click(function(){
                window.location = $(this).attr('href');
                return false;
            });

            $('.edit-center-description').click(function(){
                if($(this).next().is(':visible')) {
                	$(this).find('i').attr('class', 'icon-ok');
                	$(this).find('span').html('save')
                    $(this).next().hide().siblings('.mceEditor').show();

                } else {
                    var url = $(this).attr('href');
                    var param = { description: $(this).siblings('textarea').val() };

                	$.post(url, param, function(result){}, 'json');

                	$(this).find('i').attr('class', 'icon-edit');
                	$(this).find('span').html('edit')
                    $(this).next().html(param.description).show().siblings('.mceEditor').hide();                
                }

                return false;
            });

            $('.edit-center-name').click(function(){
                if($(this).next().is(':visible')) {
                	$(this).find('i').attr('class', 'icon-ok');
                	$(this).find('span').html('save')
                    $(this).next().hide().siblings('input').show();
            
                } else {
                    var url = $(this).attr('href');
                    var param = { name: $(this).siblings('input').val() };

                	$.post(url, param, function(result){}, 'json');

                	$(this).find('i').attr('class', 'icon-edit');
                	$(this).find('span').html('edit')
                    $(this).next().html(param.name).show().siblings('input').hide();

                	$("#centersAccordion").accordion("enable");
                }

                return false;
            }).siblings('input').click(function(){
    			$('#centersAccordion').accordion("disable").removeClass('ui-state-disabled'); 
    			$(this).parent().removeClass('ui-state-disabled'); 
    		});

        });
        
        $('input.is_close_checkbox').change(function(){
            if(this.checked) {
            	$(this).parent().parent().parent().find('.is_open_checkbox').val('0');
                $(this).parent().parent().parent().find('.is_open').val('0');
                $(this).parent().parent().parent().find('.hour').spinner({ disabled: true });
                $(this).parent().parent().parent().find('.is_open_checkbox').removeAttr('disabled');
                $(this).parent().parent().parent().next().find('.businessHourNotes').val("");
                $(this).parent().parent().parent().next().find('.businessHourNotes').attr({ disabled: true });
            }

        });
        $('input.is_open_checkbox').change(function(){
            if(this.checked) {
                $(this).parent().parent().parent().find('.hour').val("8:00 AM");
                $(this).parent().parent().parent().find('.hour').spinner({ disabled: true });
                $(this).parent().parent().parent().find('.is_open').val('1');
                $('textarea.businessHourNotes').removeAttr('disabled');
            }

        });

        $('#businessHourCheckBox').click(function(){
    	    if ($('#businessHourCheckBox').attr('checked')) {
    	    	$(this).parent().parent().parent().find('.is_open').val('1');
    	    	$(this).parent().parent().parent().find('.hour').spinner({ disabled: true }).val(" 8:00 AM");
    	    	$('textarea.businessHourNotes').removeAttr('disabled');
    	    	$(this).parent().parent().parent().find('.is_open_checkbox').attr({ checked: 'checked', disabled: true});
    	    	$(this).parent().parent().parent().find('.is_close_checkbox').removeAttr('checked');
    	        $(this).parent().parent().parent().find('.is_close_checkbox').attr({disabled : true});
    	    }else{
    	    	$(this).parent().parent().parent().find('.is_open').val('');
    	    	$(this).parent().parent().parent().find('.hour').spinner({ disabled: false }).val(" 8:00 AM");
    	    	$('textarea.businessHourNotes').removeAttr('disabled');
    	    	$(this).parent().parent().parent().find('.is_open_checkbox').removeAttr('checked');
    	    	$(this).parent().parent().parent().find('.is_open_checkbox').attr({ disabled: false});
    	    	$(this).parent().parent().parent().find('.is_close_checkbox').attr({ disabled: false});
        	}
    	}) 
        
        $('#saveBusinessHours').click(function() {
        	$('#saveBusinessHours').attr('disabled',"true");
        	_form = $('#businessHours-form');
            _form.append('<span class="loader">Loading...</span>');
            var businessHoursData = _form.serialize();
            /*if ($('#businessHourCheckBox').attr('checked')) {
                businessHoursData = '';
            }*/
            $.ajax({
                url: "{{ path('admin_institution_medicalCenter_ajaxUpdateBusinessHours', { 'institutionId':institution.id, 'imcId': institutionMedicalCenter.id }) }}",
                data: businessHoursData,
                type: 'POST',
                success: function(data) {  
          		  $('#institutionBusinessHoursText').html(data.html);
                  _form.find('span.loader').remove();
                  $('#saveBusinessHours').removeAttr('disabled');
                }
            });
            return false;
        });

        $('#btnClose').click(function() {
        	$(this).dialog('close');

         	return false;       
        });

        
        
    </script>
{% endblock %}
